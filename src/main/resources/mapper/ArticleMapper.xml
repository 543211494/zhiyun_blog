<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.nwpu.blog.mapper.ArticleMapper">
    <!--  映射结果集，id为唯一标识符  -->
    <resultMap id="article" type="org.nwpu.blog.bean.Article">
        <!--    property为java类中的属性名，column为数据库中列名    -->
        <id property="id" column="article_id" jdbcType="INTEGER"></id>
        <result property="authorId" column="article_author_id" jdbcType="INTEGER"></result>
        <result property="title" column="article_title" jdbcType="VARCHAR"></result>
        <result property="content" column="article_content" jdbcType="VARCHAR"></result>
        <result property="updateTime" column="article_update_time" jdbcType="TIMESTAMP"></result>
        <result property="createTime" column="article_create_time" jdbcType="TIMESTAMP"></result>
        <result property="summary" column="article_summary" jdbcType="VARCHAR"></result>
        <result property="thumbnail" column="article_thumbnail" jdbcType="VARCHAR"></result>
        <result property="isVisible" column="article_visible" jdbcType="INTEGER"></result>
        <result property="isDeleted" column="article_deleted" jdbcType="INTEGER"></result>
        <result property="category" column="category_name" jdbcType="VARCHAR"></result>
        <collection property="tags" ofType="org.nwpu.blog.bean.Tag">
            <id property="id" column="tag_id" jdbcType="INTEGER"></id>
            <result property="name" column="tag_name" jdbcType="VARCHAR"></result>
            <result property="updateTime" column="tag_create_time" jdbcType="TIMESTAMP"></result>
            <result property="createTime" column="tag_update_time" jdbcType="TIMESTAMP"></result>
            <result property="isDeleted" column="tag_deleted" jdbcType="INTEGER"></result>
        </collection>
    </resultMap>

    <!--  插入后返回主键  -->
    <insert id="insertArticle" parameterType="org.nwpu.blog.bean.Article" useGeneratedKeys="true" keyProperty="id" keyColumn="article_id">
        INSERT INTO article(article_author_id,article_title,article_content,
                            article_update_time,article_create_time,article_summary,
                            article_thumbnail,article_visible,article_deleted)
        VALUES (#{authorId},#{title},#{content},#{updateTime},#{createTime},#{summary},#{thumbnail},#{isVisible},#{isDeleted})
    </insert>

    <insert id="updateArticleCategory">
        INSERT INTO article_category_ref(article_id,category_id)
        VALUES (#{articleId},#{categoryId})
    </insert>

    <insert id="updateArticleTags">
        INSERT INTO article_tag_ref(article_id,tag_id)
        VALUES
        <foreach collection="tagIds" item="tagId" separator=",">
            (#{articleId},#{tagId})
        </foreach>
    </insert>

    <update id="updateArticle">
        UPDATE article SET article_title = #{article.title}, article_content = #{article.content},
                           article_summary = #{article.summary},article_update_time = #{article.updateTime},
                           article_visible = #{article.isVisible}
        WHERE article_id = #{article.id}
    </update>

    <delete id="deleteArticleCategoryById">
        DELETE FROM article_category_ref WHERE article_id = #{articleId}
    </delete>

    <delete id="deleteArticleTagsById">
        DELETE FROM article_tag_ref WHERE article_id = #{articleId}
    </delete>

    <select id="searchArticleById" resultMap="article">
        SELECT article_id,article_author_id,article_title,article_content,
               article_update_time,article_create_time,article_summary,
               article_thumbnail,article_visible,article_deleted
               <if test="isDetail">
               ,category.category_name category_name,
               tag.tag_id tag_id,tag.tag_name tag_name,tag.tag_create_time tag_create_time,
               tag.tag_update_time tag_update_time,tag.tag_deleted tag_deleted
               </if>
        FROM article<if test="isDetail">,category,tag</if> WHERE article_id = #{articleId}
        <if test="searchDelete">AND article_deleted = 0</if>
        <if test="searchPass">AND article_visible = 1</if>
        <if test="isDetail">
        AND category.category_id IN (SELECT category_id
                                    FROM article_category_ref
                                    WHERE article_id = #{articleId}) AND tag.tag_id IN(SELECT tag_id
                                                                                       FROM article_tag_ref
                                                                                       WHERE article_id = #{articleId});
        </if>
    </select>

    <update id="deleteArticleById">
        UPDATE article SET article_deleted = 1 WHERE article_id = #{articleId}
    </update>

    <update id="updateArticleVisibleById">
        UPDATE article SET article_visible = 1 WHERE article_id = #{articleId} AND article_deleted = 0
    </update>

    <insert id="scoreArticle">
        INSERT INTO score(score_user_id,score_article_id,score_number,score_create_time)
        VALUES (#{userId},#{articleId},#{score},now())
        ON DUPLICATE KEY UPDATE
        score_number = VALUES(score_number)
    </insert>

    <insert id="updateThumbnail">
        UPDATE article SET article_thumbnail = #{thumbnail} WHERE article_id = #{articleId}
    </insert>
</mapper>